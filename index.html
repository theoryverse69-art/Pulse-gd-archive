<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE | ARCHIVE v37</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&display=swap');
        body { background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; height: 100vh; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(50px); border: 1px solid rgba(255, 255, 255, 0.08); }
        #bg-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at var(--x) var(--y), rgba(0, 255, 255, 0.1) 0%, transparent 60%); z-index: -1; pointer-events: none; }
        .lvl-card { transition: all 0.3s; cursor: pointer; border: 1px solid transparent; }
        .lvl-card:hover { background: rgba(0, 255, 255, 0.05); transform: translateX(10px); border-color: rgba(0, 255, 255, 0.2); }
        .player-icon { width: 40px; height: 40px; image-rendering: pixelated; object-fit: contain; border-radius: 8px; background: rgba(255,255,255,0.05); }
        .page { display: none; height: 100vh; padding: 6rem 2rem 2rem 2rem; }
        .page-active { display: flex; animation: pEnter 0.4s ease-out; }
        @keyframes pEnter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .staff-only { display: none !important; }
        .is-staff .staff-only { display: flex !important; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>
    <div id="bg-glow"></div>
    <nav class="fixed top-0 left-0 w-full p-8 flex justify-between items-center z-[150]">
        <div onclick="nav('list')" class="text-2xl font-black italic tracking-tighter cursor-pointer">PULSE.</div>
        <div class="flex gap-8">
            <span onclick="nav('list')" class="text-[10px] font-bold uppercase cursor-pointer hover:text-cyan-400">Archive</span>
            <span onclick="nav('leaderboard')" class="text-[10px] font-bold uppercase cursor-pointer hover:text-cyan-400">Leaderboard</span>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3 glass px-4 py-2 rounded-full border-white/10">
                <div id="music-status" class="text-[8px] font-black uppercase opacity-40 italic">No Audio</div>
                <button onclick="toggleMusic()" class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center text-[10px]">⏯</button>
                <button onclick="openMusicModal()" class="staff-only w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-[10px]">⚙</button>
            </div>
            <button onclick="toggleStaff()" id="staff-indicator" class="w-3 h-3 rounded-full bg-white/10 border border-white/20"></button>
        </div>
    </nav>

    <div id="page-list" class="page gap-6">
        <aside class="w-80 flex flex-col gap-4">
            <div class="glass p-5 rounded-[2rem]">
                <input type="text" id="lvl-search" placeholder="SEARCH..." class="w-full bg-white/5 border border-white/10 p-3 rounded-xl text-[11px] outline-none mb-4" oninput="renderSidebar()">
                <button onclick="openAddModal()" class="staff-only w-full bg-white text-black font-black py-2 rounded-xl text-[10px] uppercase">Add Level</button>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scroll"></div>
        </aside>
        <main class="flex-1 glass rounded-[3rem] p-8 flex flex-col overflow-hidden relative">
            <div id="viewer-empty" class="m-auto opacity-10 font-black italic text-6xl uppercase">Pulse Archive</div>
            <div id="viewer-content" class="hidden h-full flex flex-col overflow-y-auto pr-4 custom-scroll">
                <div id="v-video-container" class="w-full max-w-5xl mx-auto mb-8 aspect-video shadow-2xl rounded-3xl overflow-hidden"></div>
                <div class="flex gap-10 max-w-5xl mx-auto w-full">
                    <div class="flex-1">
                        <h2 id="v-title" class="text-6xl font-black italic uppercase tracking-tighter mb-4"></h2>
                        <div class="flex items-center gap-4 mb-8">
                            <img id="v-ver-icon" class="player-icon !w-8 !h-8">
                            <span class="opacity-40 uppercase text-[10px] font-bold italic">Verified by <span id="v-ver" class="text-white font-black"></span></span>
                            <span class="text-cyan-400 font-black text-2xl ml-auto" id="v-pts"></span>
                        </div>
                        <div class="glass p-8 rounded-[2.5rem]">
                            <h3 class="text-[10px] font-black uppercase text-cyan-400 mb-4">Submit Record</h3>
                            <div class="flex gap-4">
                                <input id="sub-name" placeholder="Username" class="flex-1 bg-white/5 border border-white/10 p-4 rounded-2xl text-xs outline-none focus:border-cyan-500">
                                <button onclick="openVictorModal()" class="bg-white text-black px-8 font-black uppercase text-[10px] rounded-2xl">Submit</button>
                            </div>
                        </div>
                    </div>
                    <div class="w-80">
                        <div class="glass p-6 rounded-[2.5rem]">
                            <h3 class="text-[10px] font-black opacity-30 uppercase mb-6 tracking-widest">Victors</h3>
                            <div id="v-victors" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="page-leaderboard" class="page flex-col items-center overflow-y-auto custom-scroll">
        <h2 class="text-7xl font-black italic uppercase mb-12 tracking-tighter">Leaderboard</h2>
        <div id="lb-content" class="w-full max-w-3xl space-y-4"></div>
    </div>

    <div id="music-modal" class="fixed inset-0 bg-black/95 hidden z-[500] flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass p-10 rounded-[3rem] w-full max-w-md text-center">
            <h2 class="text-2xl font-black italic uppercase mb-8 tracking-tighter">Global Music</h2>
            <input id="music-yt" placeholder="PASTE YOUTUBE URL" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none text-cyan-400">
            <div class="text-[9px] opacity-20 uppercase font-black mb-4">OR UPLOAD FILE</div>
            <label class="block bg-white/10 p-4 rounded-xl border border-dashed border-white/20 text-[10px] mb-8 cursor-pointer font-bold uppercase hover:bg-white/20">
                <input type="file" id="music-upload" class="hidden" onchange="handleMusicUpload(this)">
                Pick MP3/OGG File
            </label>
            <button onclick="saveMusic()" class="w-full bg-cyan-500 text-black p-4 rounded-2xl font-black uppercase italic shadow-lg shadow-cyan-500/20">Set Global Audio</button>
            <button onclick="toggleModal('music-modal')" class="mt-4 text-[9px] opacity-30 uppercase">Cancel</button>
        </div>
    </div>

    <div id="level-modal" class="fixed inset-0 bg-black/98 hidden z-[300] flex items-center justify-center p-6"><div class="glass p-12 rounded-[4rem] w-full max-w-5xl h-[85vh] flex flex-col overflow-hidden"><h2 class="text-4xl font-black uppercase italic mb-8">Level Creator</h2><div class="flex-1 overflow-y-auto grid grid-cols-2 gap-12 custom-scroll"><div class="space-y-6"><input id="in-name" placeholder="LEVEL NAME" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none"><input id="in-ver" placeholder="VERIFIER" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none"><input id="in-pts" type="number" placeholder="POINTS" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none"><input id="in-yt-link" oninput="previewYT()" placeholder="YOUTUBE URL" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none text-cyan-400"><div class="grid grid-cols-2 gap-4"><label class="bg-white/5 border border-dashed border-white/20 p-6 rounded-3xl text-center cursor-pointer"><input type="file" class="hidden" onchange="handleFile(this, 'thumb')"><span class="text-[9px] font-black">THUMB</span></label><label class="bg-white/5 border border-dashed border-white/20 p-6 rounded-3xl text-center cursor-pointer"><input type="file" class="hidden" onchange="handleFile(this, 'ver-icon')"><span class="text-[9px] font-black">VERIFIER ICON</span></label></div></div><div><div id="p-yt-preview" class="w-full aspect-video bg-black rounded-3xl overflow-hidden mb-4 border border-white/10"></div><img id="p-icon-preview" class="player-icon !w-16 !h-16 hidden"></div></div><button onclick="saveLevel()" id="publish-btn" class="w-full bg-cyan-500 text-black font-black p-6 rounded-[2.5rem] mt-8 uppercase italic">Publish to Cloud</button></div></div>
    
    <div id="victor-modal" class="fixed inset-0 bg-black/98 hidden z-[400] flex items-center justify-center p-6"><div class="glass p-10 rounded-[3rem] w-full max-w-md text-center"><h2 class="text-xl font-black uppercase italic mb-6">Add Victor</h2><input id="vic-name" placeholder="USERNAME" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none"><label class="block bg-white/10 p-4 rounded-xl border border-white/20 text-[10px] mb-8 cursor-pointer font-bold"><input type="file" class="hidden" onchange="handleFile(this, 'vic-icon')">UPLOAD ICON</label><button onclick="confirmVictor()" class="w-full bg-cyan-500 text-black p-4 rounded-xl font-black uppercase italic">Add Victor</button></div></div>

    <div id="global-music-player"></div> <audio id="global-audio-player" loop></audio>

    <script>
        const BIN_ID = "698f025043b1c97be97bd479";
        const MASTER_KEY = "$2a$10$aQSkEXzETrsXiBcRD1c88eqNF5v5H9cPk5PhObcbVsvYLJvNTFFsS";
        const STAFF_PASS = "486970";

        let db = { levels: [], profiles: {}, music: { type: 'none', src: '' } };
        let isStaff = false, activeIdx = null, tempThumb, tempIcon, tempVicIcon, tempMusic;

        // MOUSE GLOW
        window.addEventListener('mousemove', e => {
            document.documentElement.style.setProperty('--x', e.clientX + 'px');
            document.documentElement.style.setProperty('--y', e.clientY + 'px');
        });

        async function loadDB() {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
            const data = await res.json();
            db = data.record;
            renderSidebar();
            initMusic();
        }

        async function sync() {
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY },
                body: JSON.stringify(db)
            });
            location.reload();
        }

        // --- LEADERBOARD LOGIC ---
        function renderLeaderboard() {
            const scores = {};
            db.levels.forEach(lvl => {
                // Add Verifier points
                scores[lvl.ver] = (scores[lvl.ver] || 0) + lvl.pts;
                // Add Victor points
                if (lvl.victors) {
                    lvl.victors.forEach(v => {
                        scores[v] = (scores[v] || 0) + lvl.pts;
                    });
                }
            });

            const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
            document.getElementById('lb-content').innerHTML = sorted.map(([name, pts], i) => `
                <div class="glass p-6 rounded-3xl flex items-center gap-6 border-white/5 hover:border-cyan-500/20 transition">
                    <span class="text-2xl font-black italic opacity-20 w-8">#${i+1}</span>
                    <img src="${db.profiles[name] || ''}" class="player-icon">
                    <span class="text-xl font-black uppercase flex-1 italic">${name}</span>
                    <span class="text-cyan-400 font-black text-2xl">${pts} <span class="text-[10px] opacity-50">PTS</span></span>
                </div>
            `).join('');
        }

        // --- MUSIC LOGIC ---
        function initMusic() {
            if(!db.music || db.music.type === 'none') return;
            const status = document.getElementById('music-status');
            if(db.music.type === 'yt') {
                const id = db.music.src.match(/([\w\-]{11})/)[0];
                document.getElementById('global-music-player').innerHTML = `<iframe id="yt-audio" width="0" height="0" src="https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}" frameborder="0"></iframe>`;
                status.innerText = "YouTube Audio";
            } else {
                const audio = document.getElementById('global-audio-player');
                audio.src = db.music.src;
                audio.play();
                status.innerText = "MP3 Audio";
            }
        }

        function handleMusicUpload(input) {
            const reader = new FileReader();
            reader.onload = e => tempMusic = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }

        async function saveMusic() {
            const ytUrl = document.getElementById('music-yt').value;
            if(ytUrl) {
                db.music = { type: 'yt', src: ytUrl };
            } else if(tempMusic) {
                db.music = { type: 'file', src: tempMusic };
            }
            await sync();
        }

        // --- CORE FUNCTIONS (File Handling, Save, Show) ---
        function handleFile(input, type) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = type.includes('icon') ? 64 : 400;
                    canvas.height = type.includes('icon') ? 64 : 225;
                    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                    const comp = canvas.toDataURL('image/jpeg', 0.6);
                    if(type === 'thumb') tempThumb = comp;
                    else if(type === 'ver-icon') { tempIcon = comp; document.getElementById('p-icon-preview').src = comp; document.getElementById('p-icon-preview').classList.remove('hidden'); }
                    else if(type === 'vic-icon') tempVicIcon = comp;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        async function saveLevel() {
            const ver = document.getElementById('in-ver').value;
            if(tempIcon) db.profiles[ver] = tempIcon;
            db.levels.push({
                name: document.getElementById('in-name').value,
                ver: ver,
                pts: parseInt(document.getElementById('in-pts').value) || 0,
                ytId: document.getElementById('in-yt-link').value.match(/([\w\-]{11})/)[0],
                thumb: tempThumb,
                victors: []
            });
            await sync();
        }

        async function confirmVictor() {
            const name = document.getElementById('vic-name').value;
            if(tempVicIcon) db.profiles[name] = tempVicIcon;
            db.levels[activeIdx].victors.push(name);
            await sync();
        }

        function showLvl(idx) {
            activeIdx = idx;
            const l = db.levels[idx];
            document.getElementById('viewer-empty').classList.add('hidden');
            document.getElementById('viewer-content').classList.remove('hidden');
            document.getElementById('v-title').innerText = l.name;
            document.getElementById('v-ver').innerText = l.ver;
            document.getElementById('v-pts').innerText = l.pts + " PTS";
            document.getElementById('v-video-container').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${l.ytId}" frameborder="0"></iframe>`;
            document.getElementById('v-ver-icon').src = db.profiles[l.ver] || '';
            renderVictors(idx);
        }

        function renderSidebar() {
            document.getElementById('sidebar-content').innerHTML = db.levels.map((l, i) => `
                <div onclick="showLvl(${i})" class="lvl-card glass p-4 rounded-2xl flex items-center gap-4">
                    <img src="${l.thumb || ''}" class="w-16 h-10 rounded-lg object-cover bg-white/5">
                    <p class="font-black uppercase italic text-[11px]">${l.name}</p>
                </div>`).join('');
        }

        function renderVictors(idx) {
            document.getElementById('v-victors').innerHTML = db.levels[idx].victors.map(v => `
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-2xl">
                    <img src="${db.profiles[v] || ''}" class="player-icon !w-6 !h-6">
                    <span class="text-[10px] font-black uppercase">${v}</span>
                </div>`).join('') || '<p class="text-[9px] opacity-20 italic">No victors</p>';
        }

        function toggleStaff() { if(prompt("CODE:") === STAFF_PASS) { isStaff = true; document.body.classList.add('is-staff'); } }
        function nav(p) { 
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('page-active'));
            document.getElementById('page-'+p).classList.add('page-active');
            if(p === 'leaderboard') renderLeaderboard();
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function openAddModal() { toggleModal('level-modal'); }
        function openVictorModal() { toggleModal('victor-modal'); }
        function openMusicModal() { toggleModal('music-modal'); }

        loadDB();
        nav('list');
    </script>
</body>
</html>
