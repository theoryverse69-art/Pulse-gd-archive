<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PULSE | ARCHIVE v47</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&display=swap');
        body { background: #000; color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; height: 100vh; }
        
        #bg-glow { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at var(--x) var(--y), rgba(0, 255, 255, var(--glow-op, 0.15)) 0%, transparent var(--glow-size, 50%)); 
            z-index: -1; pointer-events: none;
        }

        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .sidebar-wide { width: 460px; }
        .content-slim { flex: 1; max-width: 880px; height: 85vh; }

        .lvl-card { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); cursor: pointer; }
        .lvl-card:hover { background: rgba(0, 255, 255, 0.08); transform: translateX(10px); }
        
        .player-icon { width: 44px; height: 44px; image-rendering: pixelated; object-fit: contain; border-radius: 8px; background: #111; border: 1px solid rgba(255,255,255,0.1); }
        
        .page { display: none; height: 100vh; padding: 6rem 2rem 2rem 2rem; }
        .page-active { display: flex; animation: pEnter 0.5s ease-out; }
        @keyframes pEnter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* STRICT STAFF UI */
        .staff-only { display: none !important; }
        body.is-staff .staff-only { display: flex !important; }
        body.is-staff button.staff-only { display: block !important; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        #v-victors-container { max-height: 320px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="bg-glow"></div>
    
    <nav class="fixed top-0 left-0 w-full p-8 flex justify-between items-center z-[150]">
        <div onclick="nav('list')" class="text-2xl font-black italic tracking-tighter cursor-pointer">PULSE.</div>
        <div class="flex gap-10">
            <span onclick="nav('list')" class="text-[10px] font-bold uppercase cursor-pointer">Archive</span>
            <span onclick="nav('leaderboard')" class="text-[10px] font-bold uppercase cursor-pointer">Leaderboard</span>
            <span onclick="nav('pending')" class="staff-only text-[10px] font-bold uppercase cursor-pointer text-yellow-400">Queue</span>
        </div>
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-4 glass px-5 py-2 rounded-full">
                <div id="music-info" class="text-[8px] font-black uppercase opacity-50 italic">Visualizer</div>
                <button onclick="playNext()" class="text-xs">⏭</button>
            </div>
            <button onclick="toggleStaff()" id="staff-indicator" class="w-3 h-3 rounded-full bg-white/10 border border-white/20 transition-all duration-500"></button>
        </div>
    </nav>

    <div id="page-list" class="page gap-8 justify-center">
        <aside class="sidebar-wide flex flex-col gap-5">
            <div class="glass p-6 rounded-[2.5rem]">
                <input type="text" id="lvl-search" placeholder="SEARCH..." class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl text-[11px] outline-none mb-4" oninput="renderSidebar()">
                <button onclick="openSubmitModal('level')" class="w-full bg-white text-black font-black py-3 rounded-2xl text-[10px] uppercase">Submit Level</button>
            </div>
            <div id="sidebar-content" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scroll"></div>
        </aside>

        <main class="content-slim glass rounded-[3rem] p-8 flex flex-col relative overflow-hidden">
            <div id="viewer-empty" class="m-auto opacity-5 font-black italic text-7xl uppercase">Pulse</div>
            <div id="viewer-content" class="hidden flex-1 flex flex-col overflow-y-auto pr-4 custom-scroll">
                <div id="v-video-wrap" class="w-full aspect-video shadow-2xl rounded-[2rem] overflow-hidden bg-black mb-8 flex-shrink-0"></div>
                
                <div class="flex justify-between items-start mb-8 flex-shrink-0">
                    <div>
                        <h2 id="v-title" class="text-6xl font-black italic uppercase tracking-tighter"></h2>
                        <div class="flex items-center gap-3 mt-2">
                            <img id="v-ver-icon" class="player-icon !w-8 !h-8">
                            <span class="opacity-40 uppercase text-[9px] font-black">Verified by <span id="v-ver" class="text-white"></span></span>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-cyan-400 font-black text-4xl italic" id="v-pts"></span>
                        <div class="staff-only mt-4">
                            <button onclick="deleteCurrentLevel()" class="text-[8px] font-black text-red-500 uppercase tracking-widest bg-red-500/10 px-3 py-1 rounded-lg">Delete Level</button>
                        </div>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] flex-shrink-0 mb-4">
                    <h3 class="text-[10px] font-black opacity-30 uppercase mb-6 tracking-widest">Victors</h3>
                    <div id="v-victors-container" class="custom-scroll pr-2 mb-6">
                        <div id="v-victors" class="space-y-3"></div>
                    </div>
                    <button onclick="openSubmitModal('record')" class="w-full bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 font-black p-4 rounded-2xl text-[10px] uppercase tracking-widest hover:bg-cyan-500/20 transition">Submit Completion</button>
                </div>
            </div>
        </main>
    </div>

    <div id="page-leaderboard" class="page flex-col items-center overflow-y-auto custom-scroll">
        <h2 class="text-6xl font-black italic uppercase mb-12 tracking-tighter">Leaderboard</h2>
        <div id="lb-content" class="w-full max-w-2xl space-y-3"></div>
    </div>

    <div id="review-modal" class="fixed inset-0 bg-black/98 hidden z-[700] flex items-center justify-center p-6 backdrop-blur-xl">
        <div class="glass p-12 rounded-[4rem] w-full max-w-lg text-center">
            <h2 class="text-2xl font-black italic uppercase mb-2">Final Approval</h2>
            <p id="review-desc" class="text-[11px] opacity-40 uppercase mb-8"></p>
            
            <label class="block bg-white/5 p-12 border border-dashed border-white/20 rounded-[2rem] cursor-pointer hover:bg-white/10 transition mb-8">
                <input type="file" class="hidden" onchange="handleFile(this, 'staff-icon-pick')">
                <span class="text-[10px] font-black uppercase block">Assign Player Icon</span>
            </label>
            
            <div id="p-staff-icon-preview" class="flex justify-center mb-8 hidden">
                <img class="player-icon !w-16 !h-16 shadow-2xl">
            </div>

            <div class="flex gap-4">
                <button onclick="confirmFinalApproval()" class="flex-1 bg-green-500 text-black p-5 rounded-2xl font-black uppercase italic">Publish</button>
                <button onclick="toggleModal('review-modal')" class="p-5 text-[9px] font-black opacity-30">Back</button>
            </div>
        </div>
    </div>

    <div id="submit-modal" class="fixed inset-0 bg-black/98 hidden z-[600] flex items-center justify-center p-6">
        <div class="glass p-12 rounded-[3.5rem] w-full max-w-xl">
            <h2 id="sub-modal-title" class="text-3xl font-black italic uppercase mb-8">Submission</h2>
            <div id="sub-fields" class="space-y-4"></div>
            <button onclick="sendToQueue()" class="w-full bg-white text-black font-black p-5 rounded-2xl uppercase italic mt-6">Submit to Staff</button>
            <button onclick="toggleModal('submit-modal')" class="w-full mt-4 text-[9px] font-black opacity-30 uppercase">Cancel</button>
        </div>
    </div>

    <div id="page-pending" class="page flex-col items-center overflow-y-auto custom-scroll">
        <h2 class="text-5xl font-black italic uppercase mb-12">Staff Queue</h2>
        <div id="pending-list" class="w-full max-w-3xl space-y-4"></div>
    </div>

    <audio id="global-audio" loop></audio>
    <div id="yt-host" style="position:absolute; top:-1000px;"></div>

    <script>
        const BIN_ID = "698f025043b1c97be97bd479";
        const MASTER_KEY = "$2a$10$aQSkEXzETrsXiBcRD1c88eqNF5v5H9cPk5PhObcbVsvYLJvNTFFsS";
        const STAFF_PASS = "486970";

        let db = { levels: [], profiles: {}, playlist: [], pending: [] };
        let isStaff = false, activeIdx = null, currentSub = null, tempIcon, tempThumb, currentTrack = 0;

        // --- SESSION PERSISTENCE ---
        function checkStaffSession() {
            if (sessionStorage.getItem('pulse_staff') === 'active') {
                activateStaffMode();
            }
        }

        function toggleStaff() {
            if (isStaff) {
                if (confirm("Logout of Staff Mode?")) {
                    sessionStorage.removeItem('pulse_staff');
                    location.reload();
                }
            } else {
                if (prompt("ENTER STAFF KEY:") === STAFF_PASS) {
                    sessionStorage.setItem('pulse_staff', 'active');
                    activateStaffMode();
                    alert("Staff Mode: Persistent Session Active.");
                }
            }
        }

        function activateStaffMode() {
            isStaff = true;
            document.body.classList.add('is-staff');
            document.getElementById('staff-indicator').classList.add('bg-cyan-500', 'border-cyan-400', 'shadow-[0_0_15px_rgba(0,255,255,0.5)]');
            renderLeaderboard();
            if(activeIdx !== null) renderVictors(activeIdx);
        }

        // --- VISUALIZER ---
        let audioCtx, analyser, dataArray;
        window.addEventListener('mousemove', e => {
            document.documentElement.style.setProperty('--x', e.clientX + 'px');
            document.documentElement.style.setProperty('--y', e.clientY + 'px');
        });

        function initVis() {
            if(audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaElementSource(document.getElementById('global-audio'));
            analyser = audioCtx.createAnalyser();
            src.connect(analyser); analyser.connect(audioCtx.destination);
            analyser.fftSize = 64;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            tick();
        }

        function tick() {
            requestAnimationFrame(tick);
            if(!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            let avg = dataArray.reduce((a,b) => a+b)/dataArray.length;
            document.documentElement.style.setProperty('--glow-op', 0.1 + (avg/255));
            document.documentElement.style.setProperty('--glow-size', 40 + (avg/5) + "%");
        }

        async function loadDB() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { "X-Master-Key": MASTER_KEY } });
                const data = await res.json();
                db = data.record;
                checkStaffSession(); // Check session AFTER DB loads
                renderSidebar();
                document.body.addEventListener('click', () => { initVis(); if(db.playlist.length) playTrack(0); }, {once: true});
            } catch(e) { console.error("Database Connection Failed."); }
        }

        async function sync() {
            if(!isStaff) return alert("Unauthorized Action.");
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY }, body: JSON.stringify(db) });
            location.reload(); // Page reloads but checkStaffSession() will keep you logged in.
        }

        // --- SUBMISSION & REVIEW ---
        function openSubmitModal(type) {
            currentSub = type;
            const fields = document.getElementById('sub-fields');
            if(type === 'level') {
                fields.innerHTML = `<input id="in-l-n" placeholder="Level Name" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none"><input id="in-l-v" placeholder="Verifier" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none"><input id="in-l-p" type="number" placeholder="Points" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none"><input id="in-l-y" placeholder="YouTube Link" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none"><label class="block bg-white/5 p-4 border border-dashed border-white/10 rounded-xl text-center cursor-pointer text-[10px] font-bold"><input type="file" class="hidden" onchange="handleFile(this, 'temp-thumb')">UPLOAD THUMBNAIL</label>`;
            } else {
                fields.innerHTML = `<input id="in-r-n" placeholder="Your Name" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none"><input id="in-r-y" placeholder="YouTube Proof Link" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none">`;
            }
            toggleModal('submit-modal');
        }

        async function sendToQueue() {
            let data = { type: currentSub };
            if(currentSub === 'level') {
                data.name = document.getElementById('in-l-n').value;
                data.ver = document.getElementById('in-l-v').value;
                data.pts = parseInt(document.getElementById('in-l-p').value);
                data.yt = document.getElementById('in-l-y').value.match(/([\w\-]{11})/)[0];
                data.thumb = tempThumb;
            } else {
                data.name = document.getElementById('in-r-n').value;
                data.yt = document.getElementById('in-r-y').value;
                data.levelIdx = activeIdx;
                data.levelName = db.levels[activeIdx].name;
            }
            db.pending.push(data);
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { "Content-Type": "application/json", "X-Master-Key": MASTER_KEY }, body: JSON.stringify(db) });
            location.reload();
        }

        function startReview(idx) {
            if(!isStaff) return;
            currentSub = idx;
            const item = db.pending[idx];
            document.getElementById('review-desc').innerText = `Approving ${item.name}`;
            toggleModal('review-modal');
        }

        async function confirmFinalApproval() {
            if(!isStaff) return;
            const item = db.pending[currentSub];
            if(tempIcon) db.profiles[item.name] = tempIcon;
            if(item.type === 'level') {
                db.levels.push({ name: item.name, ver: item.name, pts: item.pts, ytId: item.yt, thumb: item.thumb, victors: [] });
            } else {
                if(!db.levels[item.levelIdx].victors.includes(item.name)) {
                    db.levels[item.levelIdx].victors.push(item.name);
                }
            }
            db.pending.splice(currentSub, 1);
            await sync();
        }

        // --- RENDERING ---
        function renderLeaderboard() {
            const scores = {};
            db.levels.forEach(lvl => {
                const pts = parseInt(lvl.pts) || 0;
                scores[lvl.ver] = (scores[lvl.ver] || 0) + pts;
                lvl.victors.forEach(v => scores[v] = (scores[v] || 0) + pts);
            });
            const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
            document.getElementById('lb-content').innerHTML = sorted.map(([name, pts], i) => `
                <div class="glass p-5 rounded-3xl flex items-center gap-6">
                    <span class="text-xl font-black italic opacity-10">#${i+1}</span>
                    <img src="${db.profiles[name] || ''}" class="player-icon">
                    <span class="text-lg font-black uppercase flex-1 italic">${name}</span>
                    <span class="text-cyan-400 font-black text-xl italic">${pts} PTS</span>
                    ${isStaff ? `<button onclick="removePlayerFromLB('${name}')" class="text-red-500 font-black text-[9px]">✕</button>` : ''}
                </div>`).join('');
        }

        function renderVictors(idx) {
            document.getElementById('v-victors').innerHTML = db.levels[idx].victors.map((v, i) => `
                <div class="flex items-center gap-3 bg-white/5 p-3 rounded-2xl">
                    <img src="${db.profiles[v] || ''}" class="player-icon !w-6 !h-6">
                    <span class="text-[10px] font-black uppercase flex-1">${v}</span>
                    ${isStaff ? `<button onclick="removeVictor(${i})" class="text-red-500">✕</button>` : ''}
                </div>`).join('') || '<p class="opacity-10 text-[10px]">No records yet</p>';
        }

        function showLvl(idx) {
            activeIdx = idx; const l = db.levels[idx];
            document.getElementById('viewer-empty').classList.add('hidden');
            document.getElementById('viewer-content').classList.remove('hidden');
            document.getElementById('v-title').innerText = l.name;
            document.getElementById('v-ver').innerText = l.ver;
            document.getElementById('v-pts').innerText = l.pts + " PTS";
            document.getElementById('v-video-wrap').innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${l.ytId}" frameborder="0" allowfullscreen></iframe>`;
            document.getElementById('v-ver-icon').src = db.profiles[l.ver] || '';
            renderVictors(idx);
        }

        function renderSidebar() {
            document.getElementById('sidebar-content').innerHTML = db.levels.map((l, i) => `
                <div onclick="showLvl(${i})" class="lvl-card glass p-4 rounded-2xl flex items-center gap-4">
                    <img src="${l.thumb}" class="w-20 h-11 rounded-lg object-cover">
                    <p class="font-black uppercase italic text-[11px]">${l.name}</p>
                </div>`).join('');
        }

        function renderPending() {
            if(!isStaff) return;
            document.getElementById('pending-list').innerHTML = db.pending.map((p, i) => `
                <div class="glass p-8 rounded-[2.5rem] flex justify-between items-center">
                    <div>
                        <span class="text-[8px] font-black uppercase text-cyan-400 border border-cyan-400/30 px-2 py-1 rounded">${p.type}</span>
                        <p class="text-xl font-black uppercase italic mt-2">${p.name} ${p.type === 'record' ? 'on ' + p.levelName : ''}</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="startReview(${i})" class="bg-green-500 text-black px-6 py-3 rounded-xl font-black text-[9px]">REVIEW</button>
                        <button onclick="if(confirm('Deny?')){db.pending.splice(${i},1);sync();}" class="text-red-500 font-black text-[9px]">DENY</button>
                    </div>
                </div>`).join('');
        }

        // --- UTILS ---
        function handleFile(input, type) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = type.includes('icon') ? 60 : 400;
                    canvas.height = type.includes('icon') ? 60 : 225;
                    canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                    const comp = canvas.toDataURL('image/jpeg', 0.6);
                    if(type === 'temp-thumb') tempThumb = comp;
                    else if(type === 'staff-icon-pick') {
                        tempIcon = comp;
                        document.querySelector('#p-staff-icon-preview img').src = comp;
                        document.getElementById('p-staff-icon-preview').classList.remove('hidden');
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function playTrack(idx) {
            currentTrack = idx; const track = db.playlist[idx];
            document.getElementById('music-info').innerText = `Track ${idx + 1}`;
            const audio = document.getElementById('global-audio'); audio.volume = 0.2;
            if(track.includes('youtube')) {
                const id = track.match(/([\w\-]{11})/)[0];
                document.getElementById('yt-host').innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}" allow="autoplay"></iframe>`;
            } else { audio.src = track; audio.play(); }
        }

        function playNext() { currentTrack = (currentTrack + 1) % db.playlist.length; playTrack(currentTrack); }
        function nav(p) { 
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('page-active'));
            document.getElementById('page-'+p).classList.add('page-active');
            if(p === 'pending') renderPending();
            if(p === 'leaderboard') renderLeaderboard();
        }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function deleteCurrentLevel() { if(isStaff && confirm("Delete level?")) { db.levels.splice(activeIdx, 1); sync(); } }
        function removeVictor(idx) { if(isStaff && confirm("Remove victor?")) { db.levels[activeIdx].victors.splice(idx, 1); sync(); } }
        function removePlayerFromLB(name) { if(isStaff && confirm("Delete player?")) { db.levels.forEach(l => l.victors = l.victors.filter(v => v !== name)); delete db.profiles[name]; sync(); } }

        loadDB(); nav('list');
    </script>
</body>
</html>
